<?xml version="1.0" encoding="utf-8"?>

<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:toolkit="http://schemas.microsoft.com/dotnet/2022/maui/toolkit"
             xmlns:mi="http://www.aathifmahir.com/dotnet/2022/maui/icons"
             xmlns:viewModels="clr-namespace:PandaCubeTimer.ViewModels"
             xmlns:models="clr-namespace:PandaCubeTimer.Models"
             xmlns:converters="clr-namespace:PandaCubeTimer.Converters"
             x:Class="PandaCubeTimer.Views.SolvesView"
             x:DataType="viewModels:SolvesViewModel"
             Title="Solves">
    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:SolveToTimeConverter x:Key="SolveToTimeConverter" />
            <converters:BoolCopyResultToCopyButtonColorConverter x:Key="BoolCopyResultToCopyButtonColorConverter"/>
            <converters:BoolCopyResultToCopyButtonTextConverter x:Key="BoolCopyResultToCopyButtonTextConverter"/>
        </ResourceDictionary>
    </ContentPage.Resources>
    
    <ContentPage.Behaviors>
        <toolkit:EventToCommandBehavior EventName="Loaded" Command="{Binding LoadSolvesCommand}"/>
    </ContentPage.Behaviors>
    
    <Grid >
        
        <RefreshView Command="{Binding LoadSolvesCommand}"
                     IsRefreshing="{Binding IsRefreshing}"
                     Padding="5">
            <CollectionView Background="Transparent"
                            ItemsSource="{Binding PuzzleSolves}">
                
                <CollectionView.EmptyView>
                    <Label Text="No solves made yet. Try your first one!"
                           FontSize="20"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           VerticalTextAlignment="Center"
                           HorizontalTextAlignment="Center" />
                </CollectionView.EmptyView>
                
                <CollectionView.ItemsLayout>
                    <GridItemsLayout Orientation="Vertical" Span="3" />
                </CollectionView.ItemsLayout>
                
                <CollectionView.ItemTemplate>
                    <DataTemplate x:DataType="models:PuzzleSolve">
                        
                        <Grid Padding="3">
                            <Frame HeightRequest="60"
                                   Padding="0">
                                
                                <Frame.GestureRecognizers>
                                    <TapGestureRecognizer CommandParameter="{Binding}"
                                                          Command="{Binding Source={RelativeSource AncestorType={x:Type viewModels:SolvesViewModel}}, Path=SelectPuzzleSolveCommand  }"/>
                                </Frame.GestureRecognizers>
                                
                                <VerticalStackLayout Padding="0"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center"
                                      Background="{AppThemeBinding Light=White, Dark=#171717}">
                                    <Label Text="{Binding Converter={StaticResource SolveToTimeConverter}}"
                                           Padding="0"
                                           FontAutoScalingEnabled="True"
                                           FontAttributes="Bold"
                                           HorizontalTextAlignment="Center"
                                           VerticalTextAlignment="Center"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"/>
                                    
                                    <Label Text="{Binding DateTime, StringFormat='{0:MMM dd, yyyy}'}"
                                           VerticalOptions="Center"
                                           VerticalTextAlignment="Center"
                                           HorizontalOptions="Center"
                                           HorizontalTextAlignment="Center"
                                           FontAttributes="Italic"
                                           FontSize="8"
                                           Margin="5, 3, 0, 0"/>
                                </VerticalStackLayout>
                                
                            </Frame>
                        </Grid>
                        
                    </DataTemplate>
                </CollectionView.ItemTemplate>
                
            </CollectionView>
        </RefreshView>
        
        <Grid IsVisible="{Binding IsOverlayVisible}"
              BackgroundColor="Transparent"
              InputTransparent="False">
            <BoxView Color="Gray" 
                     Opacity="0.5"/>
            
            <!-- <Grid.GestureRecognizers> -->
            <!--     <TapGestureRecognizer Command="{Binding ClosePuzzleSolveCommand}"/> -->
            <!-- </Grid.GestureRecognizers> -->
            
            <Frame VerticalOptions="Center"
                   HorizontalOptions="Center"
                   WidthRequest="300"
                   HeightRequest="500"
                   Padding="20">
                
                <Grid RowDefinitions="50, Auto, *">
                    <Label Grid.Row="0"
                           Text="Solve Detail"
                           FontAttributes="Bold"
                           FontFamily="Bold"
                           FontSize="20"
                           VerticalOptions="Center"
                           HorizontalOptions="Center"
                           VerticalTextAlignment="Center"
                           HorizontalTextAlignment="Center"/>
            
                    <Button Text="X"
                            Grid.Row="0"
                            VerticalOptions="Center"
                            HorizontalOptions="End"
                            Command="{Binding ClosePuzzleSolveCommand}"/>
                    
                    <!-- Separator -->
                    <BoxView Grid.Row="1"
                        HeightRequest="1"
                        Color="LightGray"
                        HorizontalOptions="Fill"
                        Margin="0,10" />
                
                    <ScrollView Grid.Row="2"
                                Orientation="Vertical"
                                Margin="0,20,0,0">
                        <StackLayout >
                            <Label Text="{Binding SelectedPuzzleSolve, Converter={StaticResource SolveToTimeConverter}}"
                                   HorizontalOptions="Center"
                                   FontSize="30"
                                   FontFamily="SemiBold"/>
                            <Label Text="{Binding SelectedPuzzleSolve.DateTime}" 
                                   HorizontalOptions="Center"/>
                            <Label Text="{Binding SelectedPuzzleSolve.Scramble}"
                                   HorizontalOptions="Center"
                                   HorizontalTextAlignment="Center"
                                   Margin="0,10,0,10"
                                   FontSize="18"/>
                            <Button Text="{Binding IsSelectedSolveCopiedSuccessfully, Converter={StaticResource BoolCopyResultToCopyButtonTextConverter}}"
                                    BackgroundColor="{Binding IsSelectedSolveCopiedSuccessfully, Converter={StaticResource BoolCopyResultToCopyButtonColorConverter}}"
                                    Margin="0, 5, 0, 5"
                                    Command="{Binding CopySolveToClipboardCommand}"/>
                            <Button Text="Delete"
                                    BackgroundColor="IndianRed"
                                    Margin="0, 5, 0, 5"
                                    Command="{Binding DeleteSelectedPuzzleSolveCommand}"/>
                            
                        </StackLayout>
                    </ScrollView>
                </Grid>
            </Frame>
            
        </Grid>
    
        <ActivityIndicator IsVisible="{Binding IsBusy}"
                           IsRunning="{Binding IsBusy}"
                           HorizontalOptions="FillAndExpand"
                           VerticalOptions="CenterAndExpand"/>   
        
    </Grid>
</ContentPage>